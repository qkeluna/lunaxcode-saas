openapi: 3.0.3
info:
  title: Lunaxcode AI Proxy API
  description: |
    Universal AI proxy service supporting multiple providers:
    OpenAI, Anthropic, Google Gemini, DeepSeek, Groq, Together AI
  version: 1.0.0
  contact:
    name: Lunaxcode
    url: https://lunaxcode-saas.pages.dev

servers:
  - url: https://lunaxcode-saas.pages.dev/api/ai
    description: Production server
  - url: http://localhost:3000/api/ai
    description: Development server

paths:
  /proxy:
    post:
      summary: Execute AI request through proxy
      description: |
        Main endpoint for proxying AI requests to various providers.
        Supports all major AI providers with unified request/response format.
      operationId: proxyAIRequest
      tags:
        - AI Proxy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AIProxyRequest'
            examples:
              openai:
                summary: OpenAI request
                value:
                  provider: openai
                  model: gpt-4o-mini
                  messages:
                    - role: system
                      content: You are a helpful assistant.
                    - role: user
                      content: What is 2+2?
                  apiKey: sk-...
                  temperature: 0.7
                  maxTokens: 100
              anthropic:
                summary: Anthropic request
                value:
                  provider: anthropic
                  model: claude-3-5-sonnet-20241022
                  messages:
                    - role: user
                      content: Generate a PRD for a mobile app
                  apiKey: sk-ant-...
      responses:
        '200':
          description: Successful AI response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIProxyResponse'
              examples:
                success:
                  value:
                    text: "2+2 equals 4."
                    usage:
                      promptTokens: 15
                      completionTokens: 8
                      totalTokens: 23
                    model: gpt-4o-mini
                    provider: openai
                    finishReason: stop
                    metadata:
                      duration: 1234
                      timestamp: "2024-10-19T12:00:00Z"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIProxyError'
              examples:
                invalid_request:
                  value:
                    error: "Provider is required"
                    code: INVALID_REQUEST
        '401':
          description: Invalid API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIProxyError'
              examples:
                invalid_key:
                  value:
                    error: "Invalid API key for openai"
                    code: INVALID_API_KEY
                    provider: openai
        '429':
          description: Rate limit exceeded
          headers:
            Retry-After:
              description: Seconds until rate limit resets
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIProxyError'
              examples:
                rate_limit:
                  value:
                    error: "Rate limit exceeded. Please try again in 45 seconds."
                    code: RATE_LIMIT_EXCEEDED
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIProxyError'
        '503':
          description: Provider unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIProxyError'
        '504':
          description: Request timeout
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIProxyError'
              examples:
                timeout:
                  value:
                    error: "Request to anthropic timed out after 30 seconds"
                    code: TIMEOUT
                    provider: anthropic

    options:
      summary: CORS preflight
      description: Handle CORS preflight requests
      operationId: proxyOptions
      tags:
        - AI Proxy
      responses:
        '204':
          description: CORS headers
          headers:
            Access-Control-Allow-Origin:
              schema:
                type: string
            Access-Control-Allow-Methods:
              schema:
                type: string
            Access-Control-Allow-Headers:
              schema:
                type: string

  /stream:
    post:
      summary: Execute streaming AI request
      description: |
        Streaming endpoint for real-time AI responses.
        Returns Server-Sent Events (SSE) stream.
      operationId: streamAIRequest
      tags:
        - AI Proxy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AIProxyRequest'
      responses:
        '200':
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string
                format: event-stream
              examples:
                stream:
                  value: |
                    data: {"text": "Hello", "done": false}
                    data: {"text": " world", "done": false}
                    data: {"text": "!", "done": true, "usage": {...}}
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIProxyError'
        '401':
          description: Invalid API key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIProxyError'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AIProxyError'

  /validate:
    post:
      summary: Validate API key
      description: |
        Validate an API key by making a minimal test request.
        Useful for checking if a key is valid before using it.
      operationId: validateAPIKey
      tags:
        - AI Proxy
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ValidateKeyRequest'
            examples:
              validate:
                value:
                  provider: openai
                  apiKey: sk-...
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateKeyResponse'
              examples:
                valid:
                  value:
                    valid: true
                    provider: openai
                invalid:
                  value:
                    valid: false
                    provider: openai
                    error: "Invalid API key"

components:
  schemas:
    AIProxyRequest:
      type: object
      required:
        - provider
        - model
        - messages
        - apiKey
      properties:
        provider:
          type: string
          enum:
            - openai
            - anthropic
            - google
            - deepseek
            - groq
            - together
          description: AI provider to use
        model:
          type: string
          description: Model identifier
          examples:
            - gpt-4o-mini
            - claude-3-5-sonnet-20241022
            - gemini-1.5-flash
        messages:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/AIMessage'
          description: Array of messages in conversation
        apiKey:
          type: string
          format: password
          description: API key for the provider
        temperature:
          type: number
          minimum: 0
          maximum: 2
          default: 0.7
          description: Sampling temperature
        maxTokens:
          type: integer
          minimum: 1
          maximum: 100000
          description: Maximum tokens to generate
        stream:
          type: boolean
          default: false
          description: Enable streaming (use /stream endpoint instead)

    AIMessage:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum:
            - system
            - user
            - assistant
          description: Message role
        content:
          type: string
          description: Message content

    AIProxyResponse:
      type: object
      required:
        - text
        - usage
        - model
        - provider
      properties:
        text:
          type: string
          description: Generated text
        usage:
          type: object
          required:
            - promptTokens
            - completionTokens
            - totalTokens
          properties:
            promptTokens:
              type: integer
              description: Number of tokens in prompt
            completionTokens:
              type: integer
              description: Number of tokens in completion
            totalTokens:
              type: integer
              description: Total tokens used
        model:
          type: string
          description: Model used
        provider:
          type: string
          description: Provider used
        finishReason:
          type: string
          enum:
            - stop
            - length
            - content_filter
            - error
          description: Why the generation stopped
        metadata:
          type: object
          properties:
            duration:
              type: integer
              description: Request duration in milliseconds
            timestamp:
              type: string
              format: date-time
              description: Response timestamp

    AIProxyError:
      type: object
      required:
        - error
        - code
      properties:
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          enum:
            - INVALID_API_KEY
            - RATE_LIMIT_EXCEEDED
            - PROVIDER_ERROR
            - TIMEOUT
            - INVALID_REQUEST
            - NETWORK_ERROR
            - UNKNOWN_ERROR
          description: Machine-readable error code
        provider:
          type: string
          description: Provider that generated the error
        details:
          type: string
          description: Additional error details

    ValidateKeyRequest:
      type: object
      required:
        - provider
        - apiKey
      properties:
        provider:
          type: string
          enum:
            - openai
            - anthropic
            - google
            - deepseek
            - groq
            - together
          description: AI provider
        apiKey:
          type: string
          format: password
          description: API key to validate

    ValidateKeyResponse:
      type: object
      required:
        - valid
        - provider
      properties:
        valid:
          type: boolean
          description: Whether the API key is valid
        provider:
          type: string
          description: Provider that was validated
        error:
          type: string
          description: Error message if validation failed

  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
      description: Optional API key for rate limit bypass (future feature)

tags:
  - name: AI Proxy
    description: Universal AI proxy endpoints
