# Onboarding Workflow & Database Schema

## Overview

This document explains the complete onboarding workflow and database relationships for the Lunaxcode SaaS platform.

## Database Schema & Relationships

### Entity Relationship Diagram

```
users (1)
   â†“ (owns)
   â†“
projects (M) â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â†“                        â”‚
   â”œâ”€â”€â†’ project_answers (M) â”‚ (stores question answers)
   â”œâ”€â”€â†’ tasks (M)           â”‚
   â”œâ”€â”€â†’ payments (M)        â”‚
   â”œâ”€â”€â†’ files (M)           â”‚
   â””â”€â”€â†’ messages (M)        â”‚
   â†‘                        â”‚
   â”‚                        â”‚
   â””â”€ references â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                service_types (1)
                    â†“
                    â”œâ”€â”€â†’ questions (M)
                         â†“
                         â””â”€â”€â†’ question_options (M)
```

### Core Tables

#### 1. **service_types** (CMS-managed)
Services offered on the platform (Landing Page, Business Website, etc.)

```sql
CREATE TABLE service_types (
  id INTEGER PRIMARY KEY,
  name TEXT NOT NULL,
  description TEXT,
  base_price INTEGER NOT NULL,
  features TEXT, -- JSON array
  timeline TEXT, -- e.g., "1-2 weeks"
  popular BOOLEAN DEFAULT FALSE,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP
);
```

#### 2. **questions** (Dynamic onboarding questions per service)
Each service type has specific questions to gather requirements.

```sql
CREATE TABLE questions (
  id INTEGER PRIMARY KEY,
  service_id INTEGER NOT NULL REFERENCES service_types(id) ON DELETE CASCADE,
  question_key TEXT NOT NULL UNIQUE, -- e.g., 'target_audience', 'design_preferences'
  question_text TEXT NOT NULL, -- "Who is your target audience?"
  question_type TEXT NOT NULL, -- 'text' | 'textarea' | 'select' | 'radio' | 'checkbox' | 'number'
  required BOOLEAN DEFAULT FALSE,
  placeholder TEXT,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP
);
```

**Note:** Current production database has `label`, `type`, `is_required` columns which need to be renamed to `question_text`, `question_type`, `required`.

#### 3. **question_options** (Options for select/radio/checkbox questions)
Predefined options for dropdown, radio, and checkbox questions.

```sql
CREATE TABLE question_options (
  id INTEGER PRIMARY KEY,
  question_id INTEGER NOT NULL REFERENCES questions(id) ON DELETE CASCADE,
  option_value TEXT NOT NULL,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP
);
```

#### 4. **users** (Client accounts)
User accounts created after onboarding.

```sql
CREATE TABLE users (
  id TEXT PRIMARY KEY, -- UUID
  name TEXT NOT NULL,
  email TEXT NOT NULL UNIQUE,
  password TEXT,
  role TEXT DEFAULT 'client', -- 'admin' | 'client'
  email_verified TIMESTAMP,
  image TEXT,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

#### 5. **projects** (Main project records)
Created when user completes onboarding and account creation.

```sql
CREATE TABLE projects (
  id INTEGER PRIMARY KEY,
  user_id TEXT NOT NULL REFERENCES users(id),
  service_type_id INTEGER NOT NULL REFERENCES service_types(id), -- âš ï¸ Changed to NOT NULL
  name TEXT NOT NULL,
  service TEXT NOT NULL, -- Denormalized service name
  description TEXT NOT NULL,
  prd TEXT, -- AI-generated PRD (nullable until generated)
  client_name TEXT NOT NULL,
  client_email TEXT NOT NULL,
  client_phone TEXT,
  timeline INTEGER, -- Can be derived from service_types
  budget INTEGER, -- Can be derived from service_types.base_price
  price INTEGER NOT NULL, -- Final calculated price
  payment_status TEXT DEFAULT 'pending', -- 'pending' | 'partially-paid' | 'paid'
  deposit_amount INTEGER DEFAULT 0,
  status TEXT DEFAULT 'pending', -- 'pending' | 'in-progress' | 'completed' | 'on-hold'
  start_date TIMESTAMP,
  end_date TIMESTAMP,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

#### 6. **project_answers** (â­ NEW TABLE - Stores question answers)
Stores the user's answers to service-specific questions during onboarding.

```sql
CREATE TABLE project_answers (
  id INTEGER PRIMARY KEY,
  project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  question_id INTEGER NOT NULL REFERENCES questions(id),
  question_key TEXT NOT NULL, -- Denormalized for quick access
  answer_value TEXT NOT NULL, -- Store as JSON string for arrays/objects
  created_at TIMESTAMP
);
```

**Example data:**
```json
[
  {
    "project_id": 1,
    "question_id": 3,
    "question_key": "design_preferences",
    "answer_value": "Modern, minimalist with dark mode"
  },
  {
    "project_id": 1,
    "question_id": 5,
    "question_key": "required_features",
    "answer_value": "[\"User Authentication\",\"Payment Integration\",\"Admin Dashboard\"]"
  }
]
```

#### 7. **tasks** (AI-generated task breakdown)
Tasks generated by AI based on the PRD.

```sql
CREATE TABLE tasks (
  id INTEGER PRIMARY KEY,
  project_id INTEGER NOT NULL REFERENCES projects(id),
  title TEXT NOT NULL,
  description TEXT NOT NULL,
  section TEXT NOT NULL,
  priority TEXT NOT NULL, -- 'low' | 'medium' | 'high'
  status TEXT DEFAULT 'pending', -- 'pending' | 'in-progress' | 'completed'
  estimated_hours INTEGER NOT NULL,
  dependencies TEXT, -- JSON array of task IDs
  order INTEGER NOT NULL,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

#### 8. **payments** (Payment records)
Tracks payments for projects (50% deposit, 50% on completion).

```sql
CREATE TABLE payments (
  id INTEGER PRIMARY KEY,
  project_id INTEGER NOT NULL REFERENCES projects(id),
  user_id TEXT NOT NULL,
  amount INTEGER NOT NULL,
  payment_method TEXT NOT NULL, -- 'card' | 'gcash' | 'paymaya'
  payment_intent_id TEXT NOT NULL,
  status TEXT NOT NULL, -- 'processing' | 'succeeded' | 'failed'
  metadata TEXT, -- JSON
  created_at TIMESTAMP,
  updated_at TIMESTAMP
);
```

---

## Complete Onboarding Workflow

### âš ï¸ IMPORTANT: User Flow Sequence

**The user does NOT have an account yet during onboarding!**

```
Step 1: Anonymous User Onboarding (No Account)
        â†“
Step 2: Account Creation (Signup/Login)
        â†“
Step 3: Project Creation from Onboarding Data
        â†“
Step 4: AI Generates PRD & Tasks
        â†“
Step 5: User Sees Project Dashboard
```

---

### 1. **Landing Page - Service Selection** (Anonymous User)
```
User â†’ Pricing Section â†’ Clicks "Get Started" on a service
      â†’ Redirects to: /onboarding?serviceId=1

âš ï¸ User is NOT logged in at this point
```

### 2. **Onboarding Page - Step 1: Project Details**
```javascript
// Page loads with pre-selected service from URL parameter
const serviceId = searchParams.get('serviceId');

// Fetch service details from database
const service = await fetch(`/api/admin/cms/services/${serviceId}`);

// Display service details (read-only):
- Service name: "Landing Page"
- Base price: "â‚±15,000"
- Timeline: "1-2 weeks"

// User fills:
- Project description (textarea, min 20 chars)
```

### 3. **Onboarding Page - Step 2: Dynamic Questions**
```javascript
// Fetch questions for this service type
const questions = await fetch(`/api/questions/${serviceId}`);

// Example questions for Landing Page service:
[
  {
    questionKey: 'page_type',
    questionText: 'What type of landing page?',
    questionType: 'select',
    options: ['Product Launch', 'Lead Generation', 'Event Registration']
  },
  {
    questionKey: 'design_style',
    questionText: 'Preferred design style',
    questionType: 'select',
    options: ['Modern', 'Minimal', 'Bold & Colorful']
  },
  {
    questionKey: 'required_sections',
    questionText: 'Required sections',
    questionType: 'checkbox',
    options: ['Hero Section', 'Features', 'Pricing', 'FAQ', 'Contact Form']
  }
]

// User answers all required questions
// Answers stored in: formData.questionAnswers
{
  'page_type': 'Product Launch',
  'design_style': 'Modern',
  'required_sections': ['Hero Section', 'Features', 'Pricing']
}
```

### 4. **Onboarding Page - Step 3: Contact Info & Summary**
```javascript
// User provides:
- Full name
- Email address
- Phone number (optional)

// Summary displays:
- Service: Landing Page
- Base Price: â‚±15k
- Timeline: 1-2 weeks
- Requirements: 5 questions answered
- Contact: John Doe â€¢ john@example.com
```

### 5. **Submit & Store in SessionStorage** (Still Anonymous)
```javascript
// âš ï¸ User is STILL NOT logged in at this point
// We store the onboarding data temporarily in browser sessionStorage

const onboardingData = {
  serviceId: '1',
  serviceName: 'Landing Page',
  description: 'A modern landing page for our SaaS product...',
  questionAnswers: {
    'page_type': 'Product Launch',
    'design_style': 'Modern',
    'required_sections': ['Hero Section', 'Features', 'Pricing']
  },
  clientName: 'John Doe',
  clientEmail: 'john@example.com',
  clientPhone: '+639123456789'
};

// Store in browser
sessionStorage.setItem('onboardingData', JSON.stringify(onboardingData));

// NOW redirect to account creation
router.push('/login?from=onboarding');
```

### 6. **User Creates Account** (Signup/Login)
```javascript
// âœ… User creates account via Google OAuth or email/password
// This creates a record in the 'users' table

// After successful authentication:
const session = await getServerSession();
console.log('User created:', session.user.id);

// Check for pending onboarding data
const onboardingData = sessionStorage.getItem('onboardingData');

if (onboardingData) {
  // User came from onboarding flow
  // Redirect to project creation API
  router.push('/api/projects/create-from-onboarding');
} else {
  // Regular login, go to dashboard
  router.push('/dashboard');
}
```

### 7. **Project Creation API** (`/api/projects/create-from-onboarding`)
```javascript
POST /api/projects/create-from-onboarding

// Request body (from sessionStorage):
{
  serviceId: 1,
  serviceName: 'Landing Page',
  description: 'A modern landing page...',
  questionAnswers: {
    'page_type': 'Product Launch',
    'design_style': 'Modern',
    'required_sections': ['Hero Section', 'Features', 'Pricing']
  },
  clientName: 'John Doe',
  clientEmail: 'john@example.com',
  clientPhone: '+639123456789'
}

// âœ… Backend process (User is NOW authenticated):

// 1. Get authenticated user (MUST be logged in)
const session = await getServerSession();
if (!session) {
  return { error: 'Unauthorized' };
}
const userId = session.user.id; // From users table

// 2. Get service details from database
const [service] = await db
  .select()
  .from(serviceTypes)
  .where(eq(serviceTypes.id, serviceId))
  .limit(1);

// 3. Create project record in 'projects' table
const [project] = await db
  .insert(projects)
  .values({
    userId: userId, // â† Link to authenticated user
    serviceTypeId: serviceId, // â† Link to service_types
    name: `${serviceName} for ${clientName}`,
    service: serviceName,
    description: description,
    clientName: clientName,
    clientEmail: clientEmail,
    clientPhone: clientPhone,
    price: service.basePrice, // Starting price from service
    timeline: null, // Will be estimated by AI
    budget: service.basePrice,
    prd: null, // â† Will be generated by AI (see step 5)
    status: 'pending',
    paymentStatus: 'pending'
  })
  .returning();

console.log('âœ… Project created:', project.id);

// 4. Store question answers in 'project_answers' table
for (const [questionKey, answerValue] of Object.entries(questionAnswers)) {
  // Get question ID from questions table
  const [question] = await db
    .select()
    .from(questions)
    .where(eq(questions.questionKey, questionKey))
    .limit(1);

  if (question) {
    // Store answer
    await db.insert(projectAnswers).values({
      projectId: project.id,
      questionId: question.id,
      questionKey: questionKey,
      answerValue: typeof answerValue === 'object'
        ? JSON.stringify(answerValue) // Store arrays/objects as JSON
        : String(answerValue)
    });
  }
}

console.log('âœ… Question answers stored');

// 5. ğŸ¤– Generate PRD using Google Gemini AI
// This uses the onboarding data + question answers
const prdPrompt = `
Create a comprehensive Project Requirements Document for:

Service Type: ${serviceName}
Client: ${clientName}
Project Description: ${description}

Client Requirements (from onboarding questions):
${Object.entries(questionAnswers)
  .map(([key, value]) => `- ${key}: ${Array.isArray(value) ? value.join(', ') : value}`)
  .join('\n')}

Generate a detailed PRD including:
1. Project Overview
2. Target Audience
3. Core Features
4. Technical Requirements
5. Design Specifications
6. Success Metrics
`;

const prd = await generatePRD(prdPrompt); // Call Google Gemini API

// 6. Update project with generated PRD
await db
  .update(projects)
  .set({ prd: prd })
  .where(eq(projects.id, project.id));

console.log('âœ… PRD generated and saved');

// 7. ğŸ¤– Generate tasks breakdown using AI (15-25 tasks)
// This analyzes the PRD and creates actionable tasks
const tasksPrompt = `
Based on this PRD:
${prd}

Generate 15-25 specific, actionable development tasks with:
- Task title
- Detailed description
- Section (Frontend, Backend, Database, Design, Testing, Deployment)
- Priority (high, medium, low)
- Estimated hours
- Dependencies (array of task IDs)
- Order
`;

const generatedTasks = await generateTasks(tasksPrompt); // Call Google Gemini API

// 8. Insert tasks into 'tasks' table
for (const task of generatedTasks) {
  await db.insert(tasks).values({
    projectId: project.id,
    title: task.title,
    description: task.description,
    section: task.section,
    priority: task.priority,
    status: 'pending',
    estimatedHours: task.estimatedHours,
    dependencies: JSON.stringify(task.dependencies),
    order: task.order
  });
}

console.log('âœ… Tasks generated and saved');

// 9. Clear sessionStorage (onboarding complete)
// This would be done on the frontend after redirect
// sessionStorage.removeItem('onboardingData');

// 10. Redirect to project dashboard
return {
  success: true,
  projectId: project.id,
  redirectUrl: `/projects/${project.id}`
};
```

### 8. **User Views Project Dashboard** ğŸ‰
```
GET /projects/[id]

User is NOW logged in and sees their project:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸš€ Landing Page Project                 â”‚
â”‚                                         â”‚
â”‚ Status: Pending Payment                 â”‚
â”‚ Service: Landing Page (â‚±15,000)         â”‚
â”‚ Timeline: 1-2 weeks                     â”‚
â”‚                                         â”‚
â”‚ ğŸ“„ PRD (AI-Generated)                   â”‚
â”‚ - Project Overview                      â”‚
â”‚ - Target Audience: Tech Startups        â”‚
â”‚ - Core Features: Hero, Pricing, CTA     â”‚
â”‚ - Design: Modern, Minimalist            â”‚
â”‚ - Tech Stack: Next.js, Tailwind         â”‚
â”‚                                         â”‚
â”‚ âœ… Tasks (18 total)                     â”‚
â”‚ [â”â”â”â”â”â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 20% Complete          â”‚
â”‚                                         â”‚
â”‚ Frontend (6 tasks)                      â”‚
â”‚  â–¡ Create hero section                  â”‚
â”‚  â–¡ Build pricing cards                  â”‚
â”‚  â–¡ Implement contact form               â”‚
â”‚                                         â”‚
â”‚ Backend (4 tasks)                       â”‚
â”‚  â–¡ Setup API endpoints                  â”‚
â”‚  â–¡ Configure database                   â”‚
â”‚                                         â”‚
â”‚ Design (3 tasks)                        â”‚
â”‚  â–¡ Create color palette                 â”‚
â”‚  â–¡ Design component library             â”‚
â”‚                                         â”‚
â”‚ ğŸ’° Payment                              â”‚
â”‚ 50% Deposit: â‚±7,500 (Pending)           â”‚
â”‚ [Pay Now Button]                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**What the client can now do:**
- âœ… View generated PRD (AI-created from their onboarding answers)
- âœ… See task breakdown (15-25 tasks organized by section)
- âœ… Track project progress (task status updates)
- âœ… Make payment (50% deposit to start)
- âœ… Communicate with agency (messages)
- âœ… Upload files
- âœ… View timeline and milestones
```

---

## Migration Plan

### Required Schema Changes

#### Phase 1: Rename Questions Table Columns (BREAKING CHANGE)
```sql
-- Rename columns in questions table
ALTER TABLE questions RENAME COLUMN label TO question_text;
ALTER TABLE questions RENAME COLUMN type TO question_type;
ALTER TABLE questions RENAME COLUMN is_required TO required;

-- Add new columns
ALTER TABLE questions ADD COLUMN sort_order INTEGER DEFAULT 0;
ALTER TABLE questions ADD COLUMN created_at INTEGER;
```

#### Phase 2: Update Projects Table
```sql
-- Make service_type_id NOT NULL (after ensuring all existing records have it)
UPDATE projects SET service_type_id = 1 WHERE service_type_id IS NULL; -- Set default
ALTER TABLE projects ALTER COLUMN service_type_id SET NOT NULL;

-- Make description NOT NULL
ALTER TABLE projects ALTER COLUMN description SET NOT NULL;

-- Make prd NULLABLE (it's generated after project creation)
-- (Already nullable in new schema)
```

#### Phase 3: Create project_answers Table (NEW)
```sql
CREATE TABLE project_answers (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  question_id INTEGER NOT NULL REFERENCES questions(id),
  question_key TEXT NOT NULL,
  answer_value TEXT NOT NULL,
  created_at INTEGER DEFAULT (strftime('%s', 'now'))
);

CREATE INDEX idx_project_answers_project_id ON project_answers(project_id);
CREATE INDEX idx_project_answers_question_id ON project_answers(question_id);
```

#### Phase 4: Update question_options Table
```sql
-- Add created_at column
ALTER TABLE question_options ADD COLUMN created_at INTEGER DEFAULT (strftime('%s', 'now'));
```

### Migration Execution Order

1. âœ… Generate migration with `npx drizzle-kit generate`
2. âš ï¸ Review generated SQL carefully
3. âš ï¸ Backup production database: `wrangler d1 backup create lunaxcode-prod`
4. âœ… Test migration on local database first
5. âœ… Apply to production: `wrangler d1 migrations apply lunaxcode-prod --remote`
6. âœ… Verify data integrity after migration

---

## API Endpoints

### Service Questions
```
GET /api/questions/[serviceId]
Returns: { questions: [...with options] }
```

### Project Creation
```
POST /api/projects/create-from-onboarding
Body: { serviceId, serviceName, description, questionAnswers, clientName, clientEmail, clientPhone }
Returns: { projectId }
```

### Retrieve Project with Answers
```
GET /api/projects/[id]/details
Returns: {
  project: {...},
  service: {...},
  answers: [
    { questionKey, questionText, answerValue }
  ],
  tasks: [...]
}
```

---

## Data Flow Summary

### Visual Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PHASE 1: ANONYMOUS ONBOARDING                    â”‚
â”‚                      (No User Account Yet)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. Landing Page
   User clicks "Get Started" on Landing Page service
   â†“
2. /onboarding?serviceId=1
   - Load service details from service_types table
   - Fetch questions from questions table WHERE service_id = 1
   â†“
3. User fills onboarding form (Step 1-3)
   - Project description
   - Answers to service-specific questions
   - Contact information
   â†“
4. Submit button clicked
   - Store ALL data in browser sessionStorage
   - Redirect to /login?from=onboarding

   sessionStorage = {
     serviceId: 1,
     serviceName: "Landing Page",
     description: "...",
     questionAnswers: {...},
     clientName: "...",
     clientEmail: "..."
   }

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PHASE 2: ACCOUNT CREATION                        â”‚
â”‚                   (User Gets Authenticated)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5. /login page
   User signs up/logs in via Google OAuth
   â†“
6. Authentication successful
   - User record created/retrieved in users table
   - Session established
   â†“
7. Check for onboarding data
   if (sessionStorage.onboardingData exists) {
     â†’ redirect to /api/projects/create-from-onboarding
   } else {
     â†’ redirect to /dashboard
   }

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PHASE 3: PROJECT & AI GENERATION                       â”‚
â”‚               (User is Now Authenticated)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

8. POST /api/projects/create-from-onboarding

   Step 8.1: Create Project Record
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INSERT INTO projects (
     user_id,              â† From authenticated session
     service_type_id,      â† From onboarding data
     description,          â† From onboarding data
     client_name,          â† From onboarding data
     price,                â† From service_types.base_price
     status: 'pending',
     prd: NULL             â† Will be generated by AI
   )

   Step 8.2: Store Question Answers
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   For each question answer:
     INSERT INTO project_answers (
       project_id,         â† From step 8.1
       question_id,        â† From questions table
       question_key,       â† e.g., 'design_preferences'
       answer_value        â† User's answer
     )

   Step 8.3: ğŸ¤– Generate PRD with AI
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Call Google Gemini API with:
   - Service type
   - Project description
   - All question answers

   Response: Comprehensive PRD document

   UPDATE projects
   SET prd = '<AI-generated PRD>'
   WHERE id = project.id

   Step 8.4: ğŸ¤– Generate Tasks with AI
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Call Google Gemini API with:
   - Generated PRD

   Response: 15-25 actionable tasks

   For each task:
     INSERT INTO tasks (
       project_id,
       title,
       description,
       section,          â† Frontend, Backend, Design, etc.
       priority,         â† high, medium, low
       status: 'pending',
       estimated_hours,
       dependencies,     â† JSON array
       order
     )

   Step 8.5: Clear SessionStorage & Redirect
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   sessionStorage.removeItem('onboardingData')
   redirect to /projects/{project.id}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 PHASE 4: CLIENT DASHBOARD                           â”‚
â”‚                  (Project Monitoring)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

9. GET /projects/[id]

   Client sees:
   âœ… Project overview (from projects table)
   âœ… Service details (from service_types table)
   âœ… Their answers (from project_answers table)
   âœ… AI-generated PRD (from projects.prd)
   âœ… Task breakdown (from tasks table)
      - Grouped by section (Frontend, Backend, Design)
      - Progress tracking (pending â†’ in-progress â†’ completed)
      - Time estimates per task
   âœ… Payment status (from payments table)
   âœ… Timeline & milestones

   Client can:
   - Monitor project progress
   - View/update task statuses (admin updates)
   - Make payments (50% deposit, 50% completion)
   - Send messages to agency
   - Upload files
```

### Database Operations by Phase

**Phase 1 (Anonymous):**
- âœ… READ: service_types (get service details)
- âœ… READ: questions (get questions for service)
- âœ… READ: question_options (get answer options)

**Phase 2 (Authentication):**
- âœ… INSERT/SELECT: users (create or get user)

**Phase 3 (Project Creation):**
- âœ… INSERT: projects (create project record)
- âœ… INSERT: project_answers (store question answers)
- âœ… UPDATE: projects (add AI-generated PRD)
- âœ… INSERT: tasks (bulk insert 15-25 tasks)

**Phase 4 (Dashboard):**
- âœ… SELECT: projects (get project details)
- âœ… SELECT: project_answers (get user's answers)
- âœ… SELECT: tasks (get task breakdown)
- âœ… SELECT: payments (get payment history)
- âœ… UPDATE: tasks (update task status - admin only)
```

---

## Important Notes

âš ï¸ **Breaking Changes:**
- Questions table columns are being renamed
- Existing API endpoints reading `label`, `type`, `is_required` need to be updated to use new names
- Service type ID is now required for projects

âœ… **Benefits:**
- Clean separation of concerns (questions vs answers)
- Flexible question system (add/remove questions without schema changes)
- Full audit trail of user responses
- Easy to generate custom PRDs based on answers
- Scalable for future service types

ğŸ”„ **Backwards Compatibility:**
- Keep `service` column in projects table for legacy support
- Migration path for existing projects without question answers

---

## Next Steps

1. [ ] Review and approve schema changes
2. [ ] Test migration on local database
3. [ ] Update API endpoints to use new column names
4. [ ] Update seed scripts for questions table
5. [ ] Implement `/api/projects/create-from-onboarding` endpoint
6. [ ] Update project detail pages to display question answers
7. [ ] Run migration on production database
